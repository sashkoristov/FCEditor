\begin{appendix}


\chapter{AFCL API Wrapper}
\label{apx:afcl-wrapper-functions}

The following listings show implementations for frequently used tasks when modifying an AFCL FC using the Java API:
\linespread{1.2}
\begin{itemize}
    \setlength\itemsep{1pt}
    \item traverse a \texttt{Workflow}: Listing \ref{lst:traverseWorkflow}
    \item get a \texttt{Function} by its name: Listing \ref{lst:getFuncByName}
    \item get a \texttt{Function}'s parent object: Listing \ref{lst:getParentObject}
    \item get dependent data items of a \texttt{Function}: Listing \ref{lst:getDataItemsBySource}
\end{itemize}
\vspace{1.4cm}

\lstset{
    breaklines=true,
    postbreak=\mbox{\textcolor{red}{$\hookrightarrow$}\space},
    basicstyle=\ttfamily\footnotesize
}

\begin{lstlisting}[language=Java,caption={traverse functions of a workflow},label={lst:traverseWorkflow}]
public static void traverseWorkflow(Workflow wf, BiConsumer<Function, Object> consumer) {
    traverseFunctions(wf.getWorkflowBody(), consumer, wf);
}

public static void traverseFunctions(List<Function> functionsList, BiConsumer<Function, Object> consumer, Object currentParent) {
    if (functionsList == null) {
        return;
    }
    for (Function fn : functionsList) {
        consumer.accept(fn, currentParent);
        if (fn instanceof IfThenElse) {
            traverseFunctions(((IfThenElse) fn).getThen(), consumer, fn);
            traverseFunctions(((IfThenElse) fn).getElse(), consumer, fn);
        }
        if (fn instanceof Switch) {
            for (Case c : ((Switch) fn).getCases()) {
                traverseFunctions(c.getFunctions(), consumer, fn);
            }
        }
        if (fn instanceof Parallel) {
            for (Section s : ((Parallel) fn).getParallelBody()) {
                traverseFunctions(s.getSection(), consumer, fn);
            }
        }
        if (fn instanceof ParallelFor) {
            traverseFunctions(((ParallelFor) fn).getLoopBody(), consumer, fn);
        }
    }
}
\end{lstlisting}

\begin{lstlisting}[language=Java,caption={get a function by its name},label=lst:getFuncByName]
public static Function getFunctionByName(Workflow wf, String name) {
    return getFunctionByName(wf.getWorkflowBody(), name);
}
    
public static Function getFunctionByName(List<Function> list, String name) {
    final AtomicReference<Function> foundFnRef = new AtomicReference<>();
    traverseFunctions(list, (fn, parentObj) -> {
        if (fn.getName() != null && fn.getName().equals(name)) {
            foundFnRef.set(fn);
        }
    });
    return foundFnRef.get();
}
\end{lstlisting}

\begin{lstlisting}[language=Java,caption={get a function's parent object},label=lst:getParentObject]
public static Object getParentObject(Workflow wf, Function fn) {
    return getParentObject(wf.getWorkflowBody(), fn, wf);
}

public static Object getParentObject(List<Function> list, Function fn, Object currentParent) {
    AtomicReference<Object> parentObjRef = new AtomicReference<>(currentParent);
    traverseFunctions(list, (functionItem, parentObj) -> {
        if (functionItem.equals(fn)) {
            parentObjRef.set(parentObj);
        }
    }, currentParent);
    return parentObjRef.get();
}
\end{lstlisting}

\clearpage

\begin{lstlisting}[language=Java,caption={get data items by source},label={lst:getDataItemsBySource}]
public static List<Object> getDataItemsBySource(Function sourceFn, List<Function> functionList) {
    List<Object> currentList = new ArrayList<>();
    if (functionList == null) {
        return currentList;
    }
    traverseFunctions(functionList, (functionItem, parentObj) -> {
        try {
            if (functionItem instanceof AtomicFunction) {
                if (((AtomicFunction) functionItem).getDataIns() != null) {
                    for (DataIns dataIns : ((AtomicFunction) functionItem).getDataIns()) {
                        if (dataIns.getSource().startsWith(sourceFn.getName() + "/")) {
                            currentList.add(dataIns);
                        }
                    }
                }
            }
            if (functionItem instanceof Compound) {
                if (((Compound) functionItem).getDataIns() != null) {
                    for (DataIns dataIns : ((Compound) functionItem).getDataIns()) {
                        if (dataIns.getSource().startsWith(sourceFn.getName() + "/")) {
                            currentList.add(dataIns);
                        }
                    }
                }
                if (((Compound) functionItem).getDataOuts() != null) {
                    for (DataOuts dataOuts : ((Compound) functionItem).getDataOuts()) {
                        if (dataOuts.getSource().startsWith(sourceFn.getName() + "/")) {
                            currentList.add(dataOuts);
                        }
                    }
                }
            }
        } catch (NullPointerException npe ) {}
    });
    return currentList;
}
\end{lstlisting}

\end{appendix}